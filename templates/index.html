<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Board Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #f3f4f6;       /* Light Grey */
            --bg-surface: #ffffff;    /* White */
            --bg-app-bar: rgba(255, 255, 255, 0.9);
            
            --text-main: #111827;     /* Almost Black */
            --text-secondary: #6b7280; 

            --primary: #3b82f6;       /* Blue */
            --primary-hover: #2563eb;
            --primary-glow: rgba(59, 130, 246, 0.3);
            
            --border-color: #e5e7eb;
            
            --lane-bg: #e5e7eb;       /* Darker grey for lane track */
            
            --card-bg: #ffffff;
            --card-border: transparent;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1); 

            --card-hover-bg: #ffffff;
            --card-hover-border: #3b82f6;
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);

            --input-bg: #f9fafb;
            --chip-bg: #ffffff;
            --chip-bg-hover: #f3f4f6;
            --chip-active-bg: #eff6ff;
            --chip-active-text: #1d4ed8;
            --chip-active-border: #3b82f6;

            --color-high-rgb: 220, 38, 38;
            --color-med-rgb:  217, 119, 6;
            --color-low-rgb:  5, 150, 105;

            --progress-fill: #10b981; 
            --radius-pill: 8px;
            --radius-card: 16px;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* --- App Bar --- */
        .app-bar {
            background: var(--bg-app-bar); /* Uses the variable */
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }

        .brand-logo i { 
            color: var(--primary); 
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        .btn-archive-toggle {
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-pill);
            padding: 8px 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-archive-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-surface);
        }

        .btn-archive-toggle.active {
            background: var(--primary);         
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--primary-glow); 
        }

        /* --- Creator Panel (Sidebar) --- */
        .creator-card {
            background: var(--bg-surface);
            border-radius: var(--radius-card);
            padding: 32px; /* Increased padding */
            border: 1px solid var(--border-color);
            position: sticky;
            top: 100px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .form-label-material {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-control-material {
            background: var(--input-bg); 
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px; /* Slightly larger inputs */
            font-size: 0.95rem;
            color: var(--text-main);
            transition: all 0.2s;
        }

        .form-control-material::placeholder { color: #475569; }

        .form-control-material:focus {
            background: var(--bg-surface);
            color: var(--text-main);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            outline: none;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .btn-primary-material {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-pill);
            padding: 12px 24px;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .btn-primary-material:hover {
            transform: translateY(-1px);
            background: var(--primary-hover);
            box-shadow: 0 6px 16px var(--primary-glow);
            filter: brightness(1.1);

        }

        /* --- Projects Chips (Filter) --- */
        .chip-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        
        .chip {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .chip:hover { 
            background: var(--bg-surface-hover); 
            color: var(--text-main);
        }
        
        .chip.active {
            background: var(--chip-active-bg);
            color: var(--chip-active-text);
            border-color: var(--chip-active-border);
        }

        .chip-count {
            font-size: 0.7rem;
            margin-left: 8px;
            opacity: 0.6;
            background: rgba(255,255,255,0.1);
            padding: 1px 6px;
            border-radius: 4px;
        }

        /* --- Kanban Lanes --- */
        .lane-wrapper {
            background: var(--lane-bg);
            border: 1px solid transparent; 
            border-radius: var(--radius-card);
            padding: 16px;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 200px);
            min-height: 75vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .lane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 4px;
            flex-shrink: 0;
        }

        .lane-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .lane-count {
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .lane-content {
            flex-grow: 1;
            overflow-y: auto;
            
            padding-top: 8px; 
            padding-left: 4px; 
            padding-right: 8px;
            padding-bottom: 20px;
            
            transition: background 0.2s;

            scrollbar-width: thin;
        }

        .lane-content.drag-over {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 12px;
            box-shadow: inset 0 0 0 2px var(--primary);
        }

        /* --- Task Cards --- */
        .task-card {
            background: var(--card-bg); 
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            color: var(--text-main);
            
            cursor: grab;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            background: var(--card-hover-bg);
            border-color: var(--card-hover-border);
            box-shadow: var(--card-hover-shadow);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: scale(0.98);
        }

        /* New Badge Styles for Priority */
        .badge-priority {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
        }
        
        .badge-priority.priority-high {
            background: rgba(var(--color-high-rgb), 0.15);
            color: rgb(var(--color-high-rgb));
            border: 1px solid rgba(var(--color-high-rgb), 0.3);
        }
        
        .badge-priority.priority-medium {
            background: rgba(var(--color-med-rgb), 0.15);
            color: rgb(var(--color-med-rgb));
            border: 1px solid rgba(var(--color-med-rgb), 0.3);
        }
        
        .badge-priority.priority-low {
            background: rgba(var(--color-low-rgb), 0.15);
            color: rgb(var(--color-low-rgb));
            border: 1px solid rgba(var(--color-low-rgb), 0.3);
        }

        .card-meta {
            display: flex;
            justify-content: space-between; /* Spread elements */
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .meta-right {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .project-tag {
            font-size: 0.65rem;
            font-weight: 700;
            color: #818cf8;
            background: rgba(99, 102, 241, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-date {
            font-size: 0.7rem;
            background: var(--bg-body);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .task-title {
            font-size: 1.05rem;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .task-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Expansion Details */
        .card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s;
            opacity: 0;
        }

        .task-card.expanded .card-details {
            max-height: 800px;
            opacity: 1;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .task-card.expanded .task-desc { -webkit-line-clamp: unset; }

        /* Action Buttons */
        .action-btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: var(--bg-body);
            color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover { background: var(--border-color); color: var(--text-main); }
        .icon-btn.delete:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }

        /* Progress Bar */
        .progress-slim {
            height: 4px;
            background-color: var(--bg-body);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--progress-fill);
            border-radius: 2px;
        }

        /* --- Modals --- */
        .modal-content {
            background-color: var(--bg-surface);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-footer { border-top: 1px solid var(--border-color); }
        .btn-close { filter: invert(1); }

        .checklist-item {
            background: var(--bg-body);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 4px;
        }
        
        .text-link { color: var(--primary); text-decoration: none; font-weight: 500;}
        .text-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <header class="app-bar">
        <div class="brand-logo">
            <i class="bi bi-kanban-fill"></i>
            <span>Personal Kanban</span>
        </div>
        <div class="d-flex gap-3">
            <button class="btn-primary-material py-2 px-4" data-bs-toggle="modal" data-bs-target="#createModal" style="width: auto; font-size: 0.9rem;">
                <i class="bi bi-plus-lg me-2"></i>New Task
            </button>
            <button id="show-archived-btn" class="btn-archive-toggle">
                <i class="bi bi-archive me-2"></i>Archive
            </button>
        </div>
    </header>

    <div class="container-fluid px-4 py-4">
        <div class="row g-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-funnel-fill text-secondary me-3"></i>
                    <div id="project-nav" class="chip-container"></div>
                </div>

                <div class="row g-4" id="board">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    
                    <div class="mb-3">
                        <label class="form-label-material">Task Name</label>
                        <input id="edit-title" class="form-control form-control-material" />
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label-material">Project</label>
                            <input id="edit-project" class="form-control form-control-material" />
                        </div>
                        <div class="col-6">
                             <label class="form-label-material">Priority</label>
                            <select id="edit-priority" class="form-select form-control-material">
                                <option>Low</option>
                                <option>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-material">Details</label>
                        <textarea id="edit-desc" class="form-control form-control-material" rows="3"></textarea>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                             <label class="form-label-material">Deadline</label>
                             <input type="date" id="edit-deadline" class="form-control form-control-material" />
                        </div>
                        <div class="col-6">
                            <label class="form-label-material">Stage</label>
                            <select id="edit-column" class="form-select form-control-material">
                                <option>Backlog</option>
                                <option>Requested</option>
                                <option>In Progress</option>
                                <option>Done</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label-material d-flex justify-content-between">
                            Checklist
                            <span class="text-link small" style="cursor:pointer" onclick="addEditSubtaskInput()">+ Add Item</span>
                        </label>
                        <div id="edit-subtask-container"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" onclick="saveEdit()" class="btn btn-primary-material" style="width: auto;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold d-flex align-items-center">
                        <i class="bi bi-plus-circle-fill me-2 text-primary"></i> New Task
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label-material">Title</label>
                        <input id="new-title" class="form-control form-control-material" placeholder="e.g. Update API">
                    </div>

                    <div class="mb-3">
                        <label class="form-label-material">Project</label>
                        <input id="new-project" list="project-suggestions" class="form-control form-control-material" placeholder="Select or type...">
                        <datalist id="project-suggestions"></datalist>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label-material">Priority</label>
                            <select id="new-priority" class="form-select form-control-material" style="cursor:pointer">
                                <option>Low</option>
                                <option selected>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label-material">Due Date</label>
                            <input type="date" id="new-deadline" class="form-control form-control-material">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-material">Description</label>
                        <textarea id="new-desc" class="form-control form-control-material" rows="3" placeholder="Brief details..."></textarea>
                    </div>

                    <input type="hidden" id="new-column" value="Backlog">

                    <div class="mb-4">
                        <label class="form-label-material d-flex justify-content-between">
                            Subtasks
                            <span class="text-link" style="cursor:pointer; font-size:0.75rem" onclick="addSubtaskInput()">+ Add</span>
                        </label>
                        <div id="subtask-input-container"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                    <button id="add-task" class="btn-primary-material" style="width: auto;">Create Task</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- LOGIC ---
        const expandedTasks = new Set();
        const STATUSES = ["Backlog", "Requested", "In Progress", "Done"];
        const archivedBtn = document.getElementById('show-archived-btn');
        let currentProjectFilter = "";

        // API
        async function fetchTasks(showArchived = false, project = null) {
            try {
                let url = `/api/tasks?archived=${showArchived ? 1 : 0}`;
                if (project) url += '&project=' + encodeURIComponent(project);
                const res = await fetch(url);
                return res.ok ? await res.json() : [];
            } catch (err) { console.error(err); return []; }
        }

        // RENDER
        async function render() {
            const showArchived = archivedBtn.classList.contains('active');
            const tasks = await fetchTasks(showArchived, currentProjectFilter);
            const board = document.getElementById('board');
            board.innerHTML = '';

            // Configuration for lane colors/styles
            const laneConfig = {
                "Backlog": { class: "lane-col-backlog" },
                "Requested": { class: "lane-col-requested" },
                "In Progress": { class: "lane-col-progress" },
                "Done": { class: "lane-col-done" },
                "Archived": { class: "lane-col-backlog" }
            };

            const cols = showArchived ? ["Archived"] : STATUSES;

            // Adjust columns based on whether sidebar is wider or not? 
            // The sidebar is col-lg-4, board is col-lg-8. Inside board, we need columns.
            // With less width for board, maybe stick to col-md-4 or col-sm-6
            
            cols.forEach(s => {
                const laneTasks = tasks.filter(t => t.column === s);
                const config = laneConfig[s] || { class: "" };
                
                // If archived, full width, else split in 3
                const colSize = showArchived ? 'col-12' : 'col-12 col-lg-3';

                const colHtml = `
                    <div class="${colSize} ${config.class}">
                        <div class="lane-wrapper" id="lane-wrapper-${s.replace(' ','')}">
                            <div class="lane-header">
                                <span class="lane-title">${s}</span>
                                <span class="lane-count">${laneTasks.length}</span>
                            </div>
                            <div class="lane-content" id="lane-${s}"></div>
                        </div>
                    </div>`;
                board.insertAdjacentHTML('beforeend', colHtml);
            });

            // Render Cards
            tasks.forEach(t => {
                if ((t.column === 'Archived') !== showArchived) return;
                
                const lane = document.getElementById('lane-' + t.column);
                if (!lane) return;

                const card = document.createElement('div');
                const pKey = (t.priority || 'Medium').toLowerCase();
                const isExpanded = expandedTasks.has(t.id);
                
                card.className = `task-card ${isExpanded ? 'expanded' : ''}`;
                card.draggable = !showArchived;
                card.dataset.id = t.id;

                // Logic for dates and subtasks
                const dayInfo = getDayInfo(t.deadline);
                const subtasks = JSON.parse(t.subtasks || "[]");
                const completedCount = subtasks.filter(s => s.completed).length;
                const totalCount = subtasks.length;
                const progressPct = totalCount ? Math.round((completedCount/totalCount)*100) : 0;

                let subtaskHtml = '';
                if(totalCount > 0) {
                    subtaskHtml = `
                        <div class="d-flex align-items-center justify-content-between mt-2 small text-secondary">
                            <span><i class="bi bi-check2-square me-1"></i>${completedCount}/${totalCount}</span>
                            <span>${progressPct}%</span>
                        </div>
                        <div class="progress-slim">
                            <div class="progress-bar-fill" style="width:${progressPct}%"></div>
                        </div>
                    `;
                }

                let checklistHtml = '';
                if(totalCount > 0) {
                    checklistHtml = `<div class="mt-3 ps-1">
                        ${subtasks.map((st, i) => `
                            <div class="d-flex gap-2 align-items-center mb-2 checklist-item">
                                <input type="checkbox" ${st.completed?'checked':''} 
                                    onclick="event.stopPropagation(); toggleSubtask(${t.id}, ${i})" 
                                    style="accent-color:var(--primary); width:16px; height:16px; cursor:pointer">
                                <span class="small ${st.completed?'text-decoration-line-through text-secondary':''}">${st.text}</span>
                            </div>
                        `).join('')}
                    </div>`;
                }

                // Render Priority Badge instead of dot
                const priorityBadge = `<span class="badge-priority priority-${pKey}">${t.priority || 'Medium'}</span>`;

                card.innerHTML = `
                    <div class="card-click-area" onclick="toggleExpand(${t.id})">
                        <div class="card-meta">
                            <div class="meta-left">
                                ${priorityBadge}
                            </div>
                            <div class="meta-right">
                                ${dayInfo ? `<span class="badge-date ${dayInfo.includes('late') ? 'text-danger border-danger' : ''}"><i class="bi bi-clock me-1"></i>${dayInfo}</span>` : ''}
                                <span class="project-tag">${t.project || 'General'}</span>
                            </div>
                        </div>
                        <div class="task-title">${t.title}</div>
                        ${t.description ? `<div class="task-desc">${t.description}</div>` : ''}
                        ${subtaskHtml}
                    </div>

                    <div class="card-details">
                        ${checklistHtml}
                        <div class="action-btn-group">
                            ${!showArchived ? `<button onclick="openEdit(${t.id})" class="icon-btn" title="Edit"><i class="bi bi-pencil-fill"></i></button>` : ''}
                            <button onclick="archiveTask(${t.id}, ${showArchived})" class="icon-btn" title="${showArchived ? 'Restore' : 'Archive'}">
                                <i class="bi ${showArchived ? 'bi-arrow-counterclockwise' : 'bi-archive-fill'}"></i>
                            </button>
                            <button onclick="deleteTask(${t.id})" class="icon-btn delete" title="Delete"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    </div>
                `;

                if (!showArchived) {
                    card.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', t.id);
                        card.classList.add('dragging');
                    });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                }
                
                lane.appendChild(card);
            });

            if (!showArchived) setupDragAndDrop();
        }

        // --- INTERACTION LOGIC ---

        function toggleExpand(id) {
            const card = document.querySelector(`.task-card[data-id="${id}"]`);
            if(!card) return;
            
            if(expandedTasks.has(id)) {
                expandedTasks.delete(id);
                card.classList.remove('expanded');
            } else {
                expandedTasks.add(id);
                card.classList.add('expanded');
            }
        }

        // Project Navigation / Chips
        async function populateProjects() {
            const [activeRaw, archivedRaw] = await Promise.all([fetchTasks(false), fetchTasks(true)]);
            const active = activeRaw.filter(t => t.column !== 'Archived');
            const archived = archivedRaw.filter(t => t.column === 'Archived');
            const all = [...active, ...archived];
            const counts = all.reduce((acc, t) => {
                const p = t.project || 'General';
                acc[p] = (acc[p] || 0) +1;
                return acc;
            }, {});

            const container = document.getElementById('project-nav');
            container.innerHTML = '';

            // 'All' Chip
            const allBtn = document.createElement('button');
            allBtn.className = `chip ${currentProjectFilter === "" ? 'active' : ''}`;
            allBtn.innerHTML = `All <span class="chip-count">${all.length}</span>`;
            allBtn.onclick = () => { currentProjectFilter = ""; populateProjects(); render(); };
            container.appendChild(allBtn);

            Object.keys(counts).sort().forEach(p => {
                const btn = document.createElement('button');
                btn.className = `chip ${currentProjectFilter === p ? 'active' : ''}`;
                btn.innerHTML = `${p} <span class="chip-count">${counts[p]}</span>`;
                btn.onclick = () => { currentProjectFilter = p; populateProjects(); render(); };
                container.appendChild(btn);
            });
            
            // Datalist
            const dl = document.getElementById('project-suggestions');
            if(dl) {
                dl.innerHTML = '';
                Object.keys(counts).forEach(p => {
                    const op = document.createElement('option');
                    op.value = p; dl.appendChild(op);
                });
            }
        }

        // Add Task
        document.getElementById('add-task').addEventListener('click', async () => {
            const title = document.getElementById('new-title').value;
            if(!title) return alert("Title required");
            
            const subtasks = Array.from(document.querySelectorAll('#subtask-input-container input')).map(i => ({text: i.value, completed: false})).filter(x => x.text);

            await fetch('/api/task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title,
                    description: document.getElementById('new-desc').value,
                    column: "Backlog",
                    priority: document.getElementById('new-priority').value,
                    project: document.getElementById('new-project').value || 'General',
                    deadline: document.getElementById('new-deadline').value || null,
                    subtasks
                })
            });
            
            // Clear inputs
            document.getElementById('new-title').value = '';
            document.getElementById('new-desc').value = '';
            document.getElementById('new-project').value = '';
            document.getElementById('new-priority').value = 'Medium';
            document.getElementById('new-deadline').value = '';
            document.getElementById('subtask-input-container').innerHTML = '';

            const modalEl = document.getElementById('createModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();

            await populateProjects();
            render();
        });

        // Subtask Helpers
        function addSubtaskInput() {
            const div = document.createElement('div');
            div.className = 'd-flex gap-2 mb-2';
            div.innerHTML = `<input class="form-control form-control-material form-control-sm" placeholder="Step..."><button class="btn btn-sm text-secondary hover-danger" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button>`;
            document.getElementById('subtask-input-container').appendChild(div);
        }

        async function toggleSubtask(id, idx) {
            // Fetch both active and archived lists to ensure we find the task anywhere
            const [active, archived] = await Promise.all([
                fetch('/api/tasks?archived=0').then(r => r.json()),
                fetch('/api/tasks?archived=1').then(r => r.json())
            ]);
            
            // Combine them
            const all = [...active, ...archived];
            const t = all.find(x => x.id === id);
            
            if(!t) return;
            
            const sub = typeof t.subtasks === 'string' ? JSON.parse(t.subtasks) : t.subtasks;
            
            if(sub[idx]) {
                sub[idx].completed = !sub[idx].completed;
                
                await fetch(`/api/task/${id}`, { 
                    method: 'PUT', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({subtasks: sub}) 
                });
                
                render();
            }
        }

        // Drag & Drop
        function setupDragAndDrop() {
            document.querySelectorAll('.lane-content').forEach(lane => {
                lane.addEventListener('dragover', e => { e.preventDefault(); lane.classList.add('drag-over'); });
                lane.addEventListener('dragleave', () => lane.classList.remove('drag-over'));
                lane.addEventListener('drop', async e => {
                    e.preventDefault(); lane.classList.remove('drag-over');
                    const id = e.dataTransfer.getData('text/plain');
                    const to = lane.id.replace('lane-', '');
                    await fetch(`/api/task/${id}/move`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to}) });
                    render();
                });
            });
        }

        // Archive/Delete wrappers
        window.archiveTask = async (id, isArchived) => {
            await fetch(`/api/task/${id}/${isArchived ? 'unarchive' : 'archive'}`, {method:'POST'});
            populateProjects(); render();
        };
        window.deleteTask = async (id) => {
            if(confirm("Delete permanently?")) {
                await fetch(`/api/task/${id}`, {method:'DELETE'});
                populateProjects(); render();
            }
        };

        // Utility
        function getDayInfo(d) {
            if(!d) return null;
            const diff = Math.ceil((new Date(d) - new Date().setHours(0,0,0,0)) / (86400000));
            if(diff < 0) return `${Math.abs(diff)}d late`;
            if(diff === 0) return `Today`;
            return `${diff}d left`;
        }

        // Edit Modal Logic (Condensed)
        function addEditSubtaskInput(val={text:'', completed:false}) {
            const d = document.createElement('div');
            d.className = 'd-flex gap-2 mb-2 align-items-center subtask-row';
            d.innerHTML = `<input type="checkbox" ${val.completed?'checked':''} class="st-check" style="accent-color:var(--primary); width:16px; height:16px"><input value="${val.text}" class="form-control form-control-material form-control-sm st-text"><button class="btn btn-sm text-secondary" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button>`;
            document.getElementById('edit-subtask-container').appendChild(d);
        }

        window.openEdit = async (id) => {
            const t = (await (await fetch('/api/tasks')).json()).find(x => x.id == id);
            if(!t) return;
            document.getElementById('edit-id').value = t.id;
            document.getElementById('edit-title').value = t.title;
            document.getElementById('edit-project').value = t.project||'';
            document.getElementById('edit-desc').value = t.description||'';
            document.getElementById('edit-priority').value = t.priority;
            document.getElementById('edit-column').value = t.column;
            document.getElementById('edit-deadline').value = t.deadline||'';
            document.getElementById('edit-subtask-container').innerHTML='';
            (JSON.parse(t.subtasks||"[]")).forEach(addEditSubtaskInput);
            new bootstrap.Modal(document.getElementById('editModal')).show();
        };

        window.saveEdit = async () => {
            const id = document.getElementById('edit-id').value;
            const subtasks = Array.from(document.querySelectorAll('.subtask-row')).map(r => ({
                text: r.querySelector('.st-text').value,
                completed: r.querySelector('.st-check').checked
            })).filter(x => x.text);
            
            await fetch(`/api/task/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    title: document.getElementById('edit-title').value,
                    project: document.getElementById('edit-project').value,
                    description: document.getElementById('edit-desc').value,
                    priority: document.getElementById('edit-priority').value,
                    column: document.getElementById('edit-column').value,
                    deadline: document.getElementById('edit-deadline').value,
                    subtasks
                })
            });
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            populateProjects(); render();
        }

        // Init
        archivedBtn.addEventListener('click', () => { archivedBtn.classList.toggle('active'); render(); });
        populateProjects().then(render);
    </script>
</body>
</html>